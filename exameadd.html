<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Painel Admin - Exames</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="flex h-screen bg-gray-100">

  <!-- Sidebar -->
  <aside class="w-64 bg-gray-800 text-white flex flex-col">
    <div class="p-6 text-center font-bold text-xl border-b border-gray-700">Admin Panel</div>
    <nav class="flex-1 p-4 space-y-2">
      <button id="btnDashboard" class="w-full text-left px-3 py-2 rounded hover:bg-gray-700">Dashboard</button>
      <button id="btnCriarExame" class="w-full text-left px-3 py-2 rounded hover:bg-gray-700">Criar Exame</button>
      <button id="btnSair" class="w-full text-left px-3 py-2 rounded hover:bg-red-700">Sair</button>
    </nav>
  </aside>

  <!-- Área principal -->
  <main class="flex-1 p-6 overflow-auto">
    <h2 class="text-2xl font-bold text-gray-800 mb-4">Painel de Exames</h2>

    <!-- Formulário de criar exame -->
    <div id="formExameContainer" class="bg-white p-6 rounded-lg shadow mb-6 hidden">
      <h3 class="text-xl font-semibold mb-4">Criar Novo Exame</h3>
      <form id="formExame" class="space-y-4">
        <input type="text" id="titulo" placeholder="Título do Exame" class="w-full border px-3 py-2 rounded" required />
        <textarea id="descricao" placeholder="Descrição" class="w-full border px-3 py-2 rounded" required></textarea>
        <input type="number" id="duracao" placeholder="Duração (minutos)" class="w-full border px-3 py-2 rounded" required />
        <input type="number" step="0.01" id="preco" placeholder="Preço (MT)" class="w-full border px-3 py-2 rounded" required />
        <input type="number" id="numeroPerguntas" placeholder="Número de Perguntas" class="w-full border px-3 py-2 rounded" required />
        <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700">Criar Exame</button>
      </form>
      <p id="messageForm" class="mt-2 text-gray-600"></p>
    </div>

    <!-- Lista de exames -->
    <div id="listaExamesContainer" class="bg-white p-6 rounded-lg shadow">
      <h3 class="text-xl font-semibold mb-4">Exames Cadastrados</h3>
      <table class="min-w-full border border-gray-200">
        <thead>
          <tr class="bg-gray-100 text-left">
            <th class="px-4 py-2 border">ID</th>
            <th class="px-4 py-2 border">Título</th>
            <th class="px-4 py-2 border">Descrição</th>
            <th class="px-4 py-2 border">Duração</th>
            <th class="px-4 py-2 border">Preço</th>
            <th class="px-4 py-2 border"># Perguntas</th>
            <th class="px-4 py-2 border">Ações</th>
          </tr>
        </thead>
        <tbody id="examesTableBody">
          <!-- Linhas serão adicionadas via JS -->
        </tbody>
      </table>
    </div>
  </main>

  <script>
    const API_URL = "https://app-quizz-backend-nodes-express-and.onrender.com";
    const token = localStorage.getItem("token");

    if (!token) {
      window.location.href = "login.html";
    }

    // Sidebar buttons
    const formContainer = document.getElementById("formExameContainer");
    const listaContainer = document.getElementById("listaExamesContainer");

    document.getElementById("btnCriarExame").addEventListener("click", () => {
      formContainer.classList.remove("hidden");
      listaContainer.classList.add("hidden");
    });

    document.getElementById("btnDashboard").addEventListener("click", () => {
      formContainer.classList.add("hidden");
      listaContainer.classList.remove("hidden");
      carregarExames();
    });

    document.getElementById("btnSair").addEventListener("click", () => {
      localStorage.removeItem("token");
      window.location.href = "login.html";
    });

    // Criar exame
    document.getElementById("formExame").addEventListener("submit", async (e) => {
      e.preventDefault();
      const titulo = document.getElementById("titulo").value;
      const descricao = document.getElementById("descricao").value;
      const duracao = document.getElementById("duracao").value;
      const preco = document.getElementById("preco").value;
      const numeroPerguntas = document.getElementById("numeroPerguntas").value;

      try {
        const res = await fetch(`${API_URL}/exames`, {
          method: "POST",
          headers: { "Content-Type": "application/json", "Authorization": `Bearer ${token}` },
          body: JSON.stringify({ titulo, descricao, duracao, preco, numeroPerguntas })
        });
        const data = await res.json();
        if (res.ok) {
          document.getElementById("messageForm").innerText = `Exame "${data.exame.titulo}" criado!`;
          form.reset();
          carregarExames();
        } else {
          document.getElementById("messageForm").innerText = `Erro: ${data.error || "Não foi possível criar o exame"}`;
        }
      } catch (err) {
        console.error(err);
        document.getElementById("messageForm").innerText = "Erro ao criar exame.";
      }
    });

    // Carregar exames
    async function carregarExames() {
      try {
        const res = await fetch(`${API_URL}/exames`, { headers: { "Authorization": `Bearer ${token}` } });
        const exames = await res.json();
        const tbody = document.getElementById("examesTableBody");
        tbody.innerHTML = "";
            exames.forEach(ex => {
            const tr = document.createElement("tr");
            tr.classList.add("border-b");
            tr.innerHTML = `
                <td class="px-4 py-2 border">${ex.id}</td>
                <td class="px-4 py-2 border">${ex.titulo}</td>
                <td class="px-4 py-2 border">${ex.descricao}</td>
                <td class="px-4 py-2 border">${ex.duracao}</td>
                <td class="px-4 py-2 border">${ex.preco}</td>
                <td class="px-4 py-2 border">${ex.numeroPerguntas}</td>
                <td class="px-4 py-2 border flex gap-2">
                <button onclick="deletarExame(${ex.id})" class="bg-red-600 text-white px-2 py-1 rounded hover:bg-red-700">Deletar</button>
                <button onclick="criarPerguntas(${ex.id}, '${encodeURIComponent(ex.titulo)}')" class="bg-green-600 text-white px-2 py-1 rounded hover:bg-green-700">Criar Perguntas</button>
                </td>
            `;
            tbody.appendChild(tr);
            });
      } catch (err) {
        console.error(err);
      }
    }

    // Deletar exame
    async function deletarExame(id) {
      if (!confirm("Deseja realmente deletar este exame?")) return;
      try {
        const res = await fetch(`${API_URL}/exames/${id}`, {
          method: "DELETE",
          headers: { "Authorization": `Bearer ${token}` }
        });
        const data = await res.json();
        console.log(data);
        carregarExames();
      } catch (err) {
        console.error(err);
      }
    }


    function criarPerguntas(exameId, exameTitulo) {
  // Pode passar título também se quiser mostrar na página addquiz
    window.location.href = `addquiz.html?exameId=${exameId}&titulo=${exameTitulo}`;
    }

    // Inicial
    carregarExames();
  </script>

</body>
</html>
